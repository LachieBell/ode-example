{% extends "base.html" %}


{% block content %}
    <div class="container">

        <h3 class="my-3">{{ ode_model.name }}</h3>
        <hr>

        {% include 'covid/ode_parameter_form.html' %}

        <hr>

        <div class="row justify-content-between" >
            <a class="btn btn-outline-primary" href='#'>Save parameters</a>
            <a class="btn btn-success" href='#' title="Watch stdout for debugging">Simulate in Django</a>
            <a class="btn btn-success" href='#' title="Watch browser console for debugging">Simulate in JavaScript</a>
        </div>



        <div class="row">
            <div class="col text-center my-2" id="svg-container"></div>
        </div>

    </div>
    <div id="data-div" data-solution='{{ data }}'></div>


{% endblock %}

{% block postscripts %}

<style type="text/css">
/* 13. Basic Styling with CSS */

/* Style the lines by removing the fill and applying a stroke */
    .line {
        fill: none;
        stroke-width: 3;
    }
      
    .overlay {
      fill: none;
      pointer-events: all;
    }

    /* Style the dots by assigning a fill and stroke */
    .dot {
        stroke: #fff;
    }
      
      .focus circle {
      fill: none;
      stroke: steelblue;
    }

</style>


<script>


    let distance_ladies = function(){
        let d = $('#id_transmission_rate').attr('value');
        $('.socially-distant').css('margin-right', d + '%');

    };

    let bind_sliders_to_displays = function(){


        $('#id_transmission_rate').on('input', function () {
            $(this).trigger('change');
        });

        $('#id_transmission_rate').change(function(e) {
              $(this).attr('value', this.value); //JS is weird sometimes.
              $('#trans-display').html(this.value);
              distance_ladies();
            });


        $('#id_recovery_rate').on('input', function () {
            $(this).trigger('change');
        });


        $('#id_recovery_rate').change(function(e) {
            $(this).attr('value', this.value); //JS is weird sometimes.
            $('#recv-display').html(this.value);

            let s = 'üè•';
            for(let i=0; i<this.value; i++){
                s += 'üè•'
            }

            $('#recovery-centres').html(s);
            });
    };



    let draw_data = function(max_t){

        let recovery_color = '#ff0000';
        let infected_color = '#3CB371';
        let susceptible_color = '#ffab00';


        const data_div = document.querySelector("#data-div");
        const data = JSON.parse(data_div.dataset.solution);
        const target_element = d3.select('#svg-container');


        //Clear the html
        target_element.html("");        

        var margin = {top: 50, right: 200, bottom: 50, left: 50}
          , width = 1200 - margin.left - margin.right
          , height = 500 - margin.top - margin.bottom;

        var n = data['recovered'].length - 1;


        var xScale = d3.scaleLinear()
            .domain([0, max_t])
            .range([0, width]); 

        let maximum = 1;

        var yScale = d3.scaleLinear()
            .domain([0, maximum]) 
            .range([height, 0]); 

        var line = d3.line()
            .x(function(d, i) { return xScale(i*(max_t/n)); })
            .y(function(d) { return yScale(d); })
            .curve(d3.curveMonotoneX) 


        var svg = target_element.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(xScale));


        svg.append("g")
            .attr("class", "y axis")
            .call(d3.axisLeft(yScale)); 





        svg.append("path")
            .datum(data['recovered'])
            .attr("class", "line") 
            .attr("d", line) 
            .attr("stroke", recovery_color);

        
        svg.append("path")
            .datum(data['infected'])
            .attr("class", "line") 
            .attr("d", line) 
            .attr("stroke", infected_color);

        
        svg.append("path")
            .datum(data['susceptible'])
            .attr("class", "line") 
            .attr("d", line) 
            .attr("stroke", susceptible_color);
    }


    $(document).ready(function() { 

                bind_sliders_to_displays();

                distance_ladies();

                draw_data(70);

            });

</script>

{% endblock %}